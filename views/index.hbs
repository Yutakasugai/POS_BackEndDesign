<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/Top-Page/style.css">
    <title>Home Page</title>
</head>
<body>

    <!-- Hero Section -->
    <div class="main">
        <div class="main-container">
            <div class="main-content">
                <h1>HAKKAKU RAMEN</h1>
                <h3>Phone Handy System</h3>
                <p>Only employees of Hakkaku Ramen Restaurant are allowed to 
                    login and activate this system. 
                </p>
                
                <button class="user-btn"><div>User</div></button>

                <button class="admin-btn"><div>Admin</div></button>

                <br><br>{{errMsg}}<br><br>
            </div>

            <div class="main-img-container">
                <img src="/images/pic-1.svg" id="main-img">
            </div>
        </div>
    </div>

    <!-- Pop up menu for Log in -->
    <div class="modal" id='user-modal'>

        <!-- This is a class for all of this modal functions -->
        <div class="modal-content">

            <!-- This is to close the SignUp page by clicking anywhere on the main page -->
            <span class="close-btn">&times;</span>

            <div class="modal-content-left">
                <img id="modal-img" src="/images/pic-3.svg">
            </div>

            <div class="modal-content-right">
                <form id="wait_permit" action="/auth/user" method="POST" class="modal-form">
                    <h1>Enter your username and password</h1>
                    
                    <!-- Get an input from the user -->
                    <div class="form-validation">
                        <input type="text" class="modal-input" id="user_name" name="user_name" placeholder="Enter your username">
                    </div>

                    <div class="form-validation">
                        <input type="password" class="modal-input" id="user_password" name="user_password" placeholder="Enter your password">
                    </div>

                    {{!-- <button type="submit" class="modal-input-btn" id="login-btn">Login</button> --}}
                    <input type="submit" class="modal-input-btn" id="login-btn" value="Login">
                    <input type="hidden" class="modal-input-btn" id="enter-btn" value="Enter">

                    <br><div class="check-msg"></div>
                    
                </form>
            </div>
        </div>
    </div>

    <!-- Pop up menu for Log in -->
    <div class="modal" id='admin-modal'>

        <!-- This is a class for all of this modal functions -->
        <div class="modal-content">

            <!-- This is to close the SignUp page by clicking anywhere on the main page -->
            <span class="close-btn-admin">&times;</span>

            <div class="modal-content-left">
                <img id="modal-img" src="/images/pic-4.svg">
            </div>

            <div class="modal-content-right">
                <form action="/auth/admin" method="POST" class="modal-form">
                    <h1>Enter your username and password</h1>
                    
                    <!-- Get an input from the user -->
                    <div class="form-validation">
                        <input type="text" class="modal-input" id="admin_name" name="admin_name" placeholder="Enter your username">
                    </div>

                    <div class="form-validation">
                        <input type="password" class="modal-input" id="admin_password" name="admin_password" placeholder="Enter your password">
                    </div>

                    {{!-- <input type="submit" name="admin-submit" class="modal-input-btn" value="Login"> --}}
                    <button type="submit" name="admin-submit" class="modal-input-btn">Login</button>
                </form>

            </div>
        </div>
    </div>

    <input type="hidden" id="userList" name="userList" value="{{nameList}}">
    {{!-- <input type="hidden" id="keyMsg" name="keyMsg" value="{{keyMsg}}"> --}}


    {{!-- Js Command --}}
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script type="text/javascript" src="/js/Top-Page/index.js"></script>
    {{!-- <script type="text/javascript" src="/ws/login.js"></script> --}}

    {{!-- Test For WebSocket Connection --}}
    <script>
        
        const userName = document.querySelector('#user_name'); 
        const userPass = document.querySelector('#user_password');
        const userList = document.getElementById('userList');
        const enterBtn = document.getElementById("enter-btn"); 
        const loginBtn = document.getElementById("login-btn");

        // const ws = new WebSocket("ws://localhost:8080");
        const ws = new WebSocket("wss://nodejs-pos-hakkaku.herokuapp.com");

        ws.addEventListener("open", () => {
            console.log("We are connected!"); 
        })

        ws.addEventListener("message", ({data}) => {

            let control_id = data.split('%');
            let current_user = userName.value; 

            console.log(control_id); 

            if(control_id[0] === "admin_permit" && control_id[1] === current_user){

                $('h4#checkMsg').remove(); 
                $('.check-msg').append('<h4 id="checkMsg">You got a permit! Press enter to log in</h4>');
                
                openModal(current_user);

            } else if (control_id[0] === "alreadyLog" && control_id[1] === current_user){

                $('h4#checkMsg').remove(); 
                $('.check-msg').append(`<h4 id="checkMsg">Please check if you already logged in or in the waitlist</h4>`);

            } else if (control_id[0] === "passedID" && control_id[1] === current_user) {


                $('h4#checkMsg').remove(); 
                $('.check-msg').append(`<h4 id="checkMsg">Hi, ${control_id[1]}. Now waiting for admin permit...</h4>`);

            } else if (data === "wrongKeys") {

                $('h4#checkMsg').remove(); 
                $('.check-msg').append(`<h4 id="checkMsg">The username or password is wrong...</h4>`);

            } else {

                console.log("Your modal not work cause you not user"); 
            }
        })

        ws.addEventListener("close", () => {
            console.log("Close a websocket connection...");
            ws.close()
        })

        // function to unlock the enter button to log in 
        function openModal(userName) {

            $('#wait_permit').unbind('submit');

            enterBtn.setAttribute('type', 'submit'); 
            loginBtn.setAttribute('type', 'hidden'); 

            enterBtn.onclick = () => {
                ws.send(`loggedID%${userName}`); 
            }
        }

        // function to stop user untill admin allow it to log in
        $('#wait_permit').on('submit', function(e){

            e.preventDefault(); 
            $('h4#checkMsg').remove(); 

            // console.log(userName.value, userPass.value); 

            if (userName.value === '') {
                $('h4#checkMsg').remove(); 
                $('.check-msg').append(`<h4 id="checkMsg">Please type your username...</h4>`); 
                return; 
            } else if (userPass.value === '') {
                $('h4#checkMsg').remove(); 
                $('.check-msg').append(`<h4 id="checkMsg">Please type your password...</h4>`); 
                return; 
            } else {
                let user_key = `wait_permit%${userName.value}:${userPass.value}`
                return ws.send(user_key); 
            }
        })

    </script>

</body>
</html>

